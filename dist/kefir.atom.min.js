!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("infestines"),require("kefir"),require("partial.lenses")):"function"==typeof define&&define.amd?define(["exports","infestines","kefir","partial.lenses"],e):e((t.kefir=t.kefir||{},t.kefir.atom=t.kefir.atom||{}),t.I,t.kefir,t.L)}(this,function(t,e,i,n){"use strict";function r(t,e){t.warned||(t.warned=1,console.warn(g+e))}function o(t){throw new Error(g+t)}function s(){for(;A.length;){var t=A.shift(),i=b.shift(),n=i._currentEvent.value;e.identicalU(t,n)||i._emitValue(n)}}function u(t){++p;try{return t()}finally{--p||s()}}function c(){i.Property.call(this)}function a(t){c.call(this),this._source=t,this._$onAny=void 0}function f(t,e){a.call(this,t),this._lens=e}function h(){c.call(this),arguments.length&&this._emitValue(arguments[0])}function l(t){r(l,"Join is an experimental feature and might be removed"),c.call(this),this._sources=t,this._source=this._$onSources=this._$onSource=void 0}function _(t,i){if(t instanceof c&&i.indexOf(t)<0)i.push(t);else if(e.isArray(t))for(var n=0,r=t.length;n<r;++n)_(t[n],i);else if(e.isObject(t))for(var o in t)_(t[o],i)}function v(t){if(t instanceof c)return t.get();if(e.isArray(t)){for(var i=t.length,n=t,r=0;r<i;++r){var o=v(t[r]);e.identicalU(n[r],o)||(n===t&&(n=t.slice(0)),n[r]=o)}return n}if(e.isObject(t)){var s=t;for(var u in t){var a=v(t[u]);e.identicalU(s[u],a)||(s===t&&(s=e.assocPartialU(void 0,void 0,t)),s[u]=a)}return s}return t}function d(t,i){if(t instanceof c)return t.set(i);if(e.isArray(t)&&e.isArray(i))for(var n=0,r=t.length;n<r;++n)d(t[n],i[n]);else if(e.isObject(t)&&e.isObject(i))for(var s in t)d(t[s],i[s]);else e.identicalU(t,i)||o("Molecule cannot change the template.")}function m(t){var e=[];_(t,e),a.call(this,e.length?i.combine(e):S),this._template=t}function y(){return arguments.length?new h(arguments[0]):new h}var g="kefir.atom: ",p=0,A=[],b=[];e.inherit(c,i.Property,{set:function(t){this.modify(e.always(t))},remove:function(){this.set()},view:function(t){return new f(this,t)},_maybeEmitValue:function(t){var i=this._currentEvent;i&&e.identicalU(i.value,t)||this._emitValue(t)}}),e.inherit(a,c,{get:function(){var t=this._currentEvent;return t&&!p?t.value:this._getFromSource()},_onAny:function(t){switch(t.type){case"value":return this._maybeEmitValue(this._getFromSource());case"error":return this._emitError(t.value);default:return this._$onAny=void 0,this._emitEnd()}},_onActivation:function(){var t=this;this._source.onAny(this._$onAny=function(e){return t._onAny(e)})},_onDeactivation:function(){var t=this._$onAny;t&&this._source.offAny(t),this._$onAny=void 0}}),e.inherit(f,a,{set:function(t){this._source.set(n.set(this._lens,t,this._source.get()))},modify:function(t){this._source.modify(n.modify(this._lens,t))},_getFromSource:function(){return n.get(this._lens,this._source.get())}}),e.inherit(h,c,{get:function(){var t=this._currentEvent;return t?t.value:void 0},set:function(t){var e=this._currentEvent;this._set(e,e?e.value:void 0,t)},modify:function(t){var e=this._currentEvent,i=e?e.value:void 0;this._set(e,i,t(i))},_set:function(t,e,i){p?(b.indexOf(this)<0&&(A.push(t?e:o),b.push(this)),t?t.value=i:this._currentEvent={type:"value",value:i}):this._maybeEmitValue(i)}}),e.inherit(l,c,{get:function(){var t=this._source;return t&&t.get()},modify:function(t){var e=this._source;e&&e.modify(t)},_onSources:function(t){var e=this;switch(t.type){case"value":return this._maybeUnsubSource(),(this._source=t.value).onAny(this._$onSource=function(t){return e._onSource(t)});case"error":return this._emitError(t.value);default:this._$onSources=void 0}},_onSource:function(t){switch(t.type){case"value":return this._maybeEmitValue(this._source.get());case"error":return this._emitError(t.value);default:return this._emitEnd()}},_onActivation:function(){var t=this,e=this._sources;e&&e.onAny(this._$onSources=function(e){return t._onSources(e)})},_onDeactivation:function(){this._maybeUnsubSource();var t=this._$onSources;t&&this._sources.offAny(t),this._$onSources=void 0},_maybeUnsubSource:function(){var t=this._$onSource;t&&this._source.offAny(t),this._source=this._$onSource=void 0}});var S=i.constant(e.array0);e.inherit(m,a,{_getFromSource:function(){return v(this._template)},modify:function(t){var e=this,i=t(this.get());u(function(){return d(e._template,i)})}}),t.holding=u,t.AbstractMutable=c,t.MutableWithSource=a,t.LensedAtom=f,t.Atom=h,t.Join=l,t.Molecule=m,t.default=y,Object.defineProperty(t,"__esModule",{value:!0})});
