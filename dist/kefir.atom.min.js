!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("infestines"),require("kefir"),require("partial.lenses")):"function"==typeof define&&define.amd?define(["exports","infestines","kefir","partial.lenses"],e):e((t.Kefir=t.Kefir||{},t.Kefir.atom={}),t.I,t.Kefir,t.L)}(this,function(t,e,i,n){"use strict";function r(t){throw new Error(h+t)}function o(t){++l;try{return t()}finally{--l||function(){for(;v.length;){var t=v.shift(),i=_.shift(),n=i._currentEvent.value;e.identicalU(t,n)||i._emitValue(n)}}()}}function s(t,i){var n=t._currentEvent;n&&e.identicalU(n.value,i)||t._emitValue(i)}function u(t,e,i,n){l?(_.indexOf(t)<0&&(v.push(e?i:r),_.push(t)),e?e.value=n:t._currentEvent={type:a,value:n}):s(t,n)}function c(t){var e=t._$onSource;e&&t._source.offAny(e),t._source=t._$onSource=void 0}var f=i.constant(e.array0),a=void 0;f.onAny(function(t){return a=a||t.type});var h="kefir.atom: ",l=0,v=[],_=[],d=e.inherit(function(){i.Property.call(this)},i.Property,{set:function(t){this.modify(e.always(t))},remove:function(){this.set()},view:e.id(function(t){return new m(this,t)})}),y=e.inherit(e.id(function(t){d.call(this),this._source=t,this._$onAny=void 0}),d,{get:function(){var t=this._currentEvent;return t&&!l?t.value:this._getFromSource()},_onActivation:function(){var t=this;this._source.onAny(this._$onAny=function(e){var i=e.type;i===a?s(t,t._getFromSource()):"error"===i?t._emitError(e.value):(t._$onAny=void 0,t._emitEnd())})},_onDeactivation:function(){var t=this._$onAny;t&&this._source.offAny(t),this._$onAny=void 0}}),m=e.inherit(function(t,e){y.call(this,t),this._lens=e},y,{set:function(t){this._source.set(n.set(this._lens,t,this._source.get()))},modify:function(t){this._source.modify(n.modify(this._lens,t))},_getFromSource:function(){return n.get(this._lens,this._source.get())}}),g=e.inherit(function(){d.call(this),arguments.length&&this._emitValue(arguments[0])},d,{get:function(){var t=this._currentEvent;return t?t.value:void 0},set:function(t){var e=this._currentEvent;u(this,e,e?e.value:void 0,t)},modify:function(t){var e=this._currentEvent,i=e?e.value:void 0;u(this,e,i,t(i))}}),p=e.inherit(e.id(function(t){d.call(this),this._sources=t,this._source=this._$onSources=this._$onSource=void 0}),d,{get:e.id(function(){var t=this._source;return t&&t.get()}),modify:e.id(function(t){var e=this._source;e&&e.modify(t)}),_onActivation:function(){var t=this,e=this._sources;e&&e.onAny(this._$onSources=function(e){var i=e.type;i===a?(c(t),(t._source=e.value).onAny(t._$onSource=function(e){var i=e.type;i===a?s(t,t._source.get()):"error"===i?t._emitError(e.value):t._emitEnd()})):"error"===i?t._emitError(e.value):t._$onSources=void 0})},_onDeactivation:function(){c(this);var t=this._$onSources;t&&this._sources.offAny(t),this._$onSources=void 0}}),A=e.inherit(function(t){var n=[];!function t(i,n){if(i instanceof d&&n.indexOf(i)<0)n.push(i);else if(e.isArray(i))for(var r=0,o=i.length;r<o;++r)t(i[r],n);else if(e.isObject(i))for(var s in i)t(i[s],n)}(t,n),y.call(this,n.length?i.combine(n):f),this._template=t},y,{_getFromSource:function(){return function t(i){if(i instanceof d)return i.get();if(e.isArray(i)){for(var n=i.length,r=i,o=0;o<n;++o){var s=t(i[o]);e.identicalU(r[o],s)||(r===i&&(r=i.slice(0)),r[o]=s)}return r}if(e.isObject(i)){var u=i;for(var c in i){var f=t(i[c]);e.identicalU(u[c],f)||(u===i&&(u=e.assocPartialU(void 0,void 0,i)),u[c]=f)}return u}return i}(this._template)},modify:function(t){var i=this,n=t(this.get());o(function(){return function t(i,n){if(i instanceof d)i.set(n);else if(e.isArray(i)&&e.isArray(n))for(var o=0,s=i.length;o<s;++o)t(i[o],n[o]);else if(e.isObject(i)&&e.isObject(n))for(var u in i)t(i[u],n[u]);else e.identicalU(i,n)||r("Molecule cannot change the template.")}(i._template,n)})}});t.holding=o,t.AbstractMutable=d,t.MutableWithSource=y,t.LensedAtom=m,t.Atom=g,t.Join=p,t.Molecule=A,t.default=function(){return arguments.length?new g(arguments[0]):new g},Object.defineProperty(t,"__esModule",{value:!0})});
