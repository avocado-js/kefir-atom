!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("infestines"),require("kefir"),require("partial.lenses")):"function"==typeof define&&define.amd?define(["exports","infestines","kefir","partial.lenses"],e):e((t.kefir=t.kefir||{},t.kefir.atom={}),t.I,t.Kefir,t.L)}(this,function(t,e,i,n){"use strict";function r(t){throw new Error(d+t)}function o(t){++y;try{return t()}finally{--y||function(){for(;m.length;){var t=m.shift(),i=g.shift(),n=i._currentEvent.value;e.identicalU(t,n)||i._emitValue(n)}}()}}function s(t,i){var n=t._currentEvent;n&&e.identicalU(n.value,i)||t._emitValue(i)}function u(t,e,i,n){y?(g.indexOf(t)<0&&(m.push(e?i:r),g.push(t)),e?e.value=n:t._currentEvent={type:_,value:n}):s(t,n)}function c(t){var e=t._$onSource;e&&t._source.offAny(e),t._source=t._$onSource=void 0}function f(t,i){if(t instanceof p&&i.indexOf(t)<0)i.push(t);else if(e.isArray(t))for(var n=0,r=t.length;n<r;++n)f(t[n],i);else if(e.isObject(t))for(var o in t)f(t[o],i)}function a(t){if(t instanceof p)return t.get();if(e.isArray(t)){for(var i=t.length,n=t,r=0;r<i;++r){var o=a(t[r]);e.identicalU(n[r],o)||(n===t&&(n=t.slice(0)),n[r]=o)}return n}if(e.isObject(t)){var s=t;for(var u in t){var c=a(t[u]);e.identicalU(s[u],c)||(s===t&&(s=e.assocPartialU(void 0,void 0,t)),s[u]=c)}return s}return t}function h(t,i){if(t instanceof p)t.set(i);else if(e.isArray(t)&&e.isArray(i))for(var n=0,o=t.length;n<o;++n)h(t[n],i[n]);else if(e.isObject(t)&&e.isObject(i))for(var s in t)h(t[s],i[s]);else e.identicalU(t,i)||r("Molecule cannot change the template.")}var l=i.constant(e.array0),v="error",_=void 0;l.onAny(function(t){return _=_||t.type});var d="kefir.atom: ",y=0,m=[],g=[],p=e.inherit(function(){i.Property.call(this)},i.Property,{set:function(t){this.modify(e.always(t))},remove:function(){this.set()},view:e.id(function(t){return new S(this,t)})}),A=e.inherit(e.id(function(t){p.call(this),this._source=t,this._$onAny=void 0}),p,{get:function(){var t=this._currentEvent;return t&&!y?t.value:this._getFromSource()},_onActivation:function(){var t=this;this._source.onAny(this._$onAny=function(e){var i=e.type;i===_?s(t,t._getFromSource()):i===v?t._emitError(e.value):(t._$onAny=void 0,t._emitEnd())})},_onDeactivation:function(){var t=this._$onAny;t&&this._source.offAny(t),this._$onAny=void 0}}),S=e.inherit(function(t,e){A.call(this,t),this._lens=e},A,{set:function(t){this._source.set(n.set(this._lens,t,this._source.get()))},modify:function(t){this._source.modify(n.modify(this._lens,t))},_getFromSource:function(){return n.get(this._lens,this._source.get())}}),$=e.inherit(function(){p.call(this),arguments.length&&this._emitValue(arguments[0])},p,{get:function(){var t=this._currentEvent;return t?t.value:void 0},set:function(t){var e=this._currentEvent;u(this,e,e?e.value:void 0,t)},modify:function(t){var e=this._currentEvent,i=e?e.value:void 0;u(this,e,i,t(i))}}),E=e.inherit(e.id(function(t){p.call(this),this._sources=t,this._source=this._$onSources=this._$onSource=void 0}),p,{get:e.id(function(){var t=this._source;return t&&t.get()}),modify:e.id(function(t){var e=this._source;e&&e.modify(t)}),_onActivation:function(){var t=this,e=this._sources;e&&e.onAny(this._$onSources=function(e){var i=e.type;i===_?(c(t),(t._source=e.value).onAny(t._$onSource=function(e){var i=e.type;i===_?s(t,t._source.get()):i===v?t._emitError(e.value):t._emitEnd()})):i===v?t._emitError(e.value):t._$onSources=void 0})},_onDeactivation:function(){c(this);var t=this._$onSources;t&&this._sources.offAny(t),this._$onSources=void 0}}),b=e.inherit(function(t){var e=[];f(t,e),A.call(this,e.length?i.combine(e):l),this._template=t},A,{_getFromSource:function(){return a(this._template)},modify:function(t){var e=this,i=t(this.get());o(function(){return h(e._template,i)})}});t.holding=o,t.AbstractMutable=p,t.MutableWithSource=A,t.LensedAtom=S,t.Atom=$,t.Join=E,t.Molecule=b,t.default=function(){return arguments.length?new $(arguments[0]):new $},Object.defineProperty(t,"__esModule",{value:!0})});
