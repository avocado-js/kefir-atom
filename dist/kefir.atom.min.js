!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("infestines"),require("kefir"),require("partial.lenses")):"function"==typeof define&&define.amd?define(["exports","infestines","kefir","partial.lenses"],e):e((t.Kefir=t.Kefir||{},t.Kefir.atom={}),t.I,t.Kefir,t.L)}(this,function(t,f,i,e){"use strict";function s(t){throw new Error(v+t)}function n(t){++d;try{return t()}finally{--d||function(){for(;y.length;){var t=y.shift(),e=m.shift(),i=e._currentEvent.value;f.identicalU(t,i)||e._emitValue(i)}}()}}function r(t,e){var i=t._currentEvent;i&&f.identicalU(i.value,e)||t._emitValue(e)}function o(t,e,i,n){d?(m.indexOf(t)<0&&(y.push(e?i:s),m.push(t)),e?e.value=n:t._currentEvent={type:l,value:n}):r(t,n)}function u(t){var e=t._$onSource;e&&t._source.offAny(e),t._source=t._$onSource=void 0}function c(){return arguments.length?new S(arguments[0]):new S}var a=i.constant(f.array0),h="error",l=void 0;a.onAny(function(t){return l=l||t.type});var v="kefir.atom: ",_=function(t){return t instanceof g},d=0,y=[],m=[],g=f.inherit(function(){i.Property.call(this)},i.Property,{set:function(t){this.modify(f.always(t))},remove:function(){this.set()},view:(0,f.id)(function(t){return new A(this,t)})}),p=f.inherit((0,f.id)(function(t){g.call(this),this._source=t,this._$onAny=void 0}),g,{get:function(){var t=this._currentEvent;return t&&!d?t.value:this._getFromSource()},_onActivation:function(){var i=this;this._source.onAny(this._$onAny=function(t){var e=t.type;e===l?r(i,i._getFromSource()):e===h?i._emitError(t.value):(i._$onAny=void 0,i._emitEnd())})},_onDeactivation:function(){var t=this._$onAny;t&&this._source.offAny(t),this._$onAny=void 0}}),A=f.inherit(function(t,e){p.call(this,t),this._lens=e},p,{set:function(t){this._source.set(e.set(this._lens,t,this._source.get()))},modify:function(t){this._source.modify(e.modify(this._lens,t))},_getFromSource:function(){return e.get(this._lens,this._source.get())}}),S=f.inherit(function(){g.call(this),arguments.length&&this._emitValue(arguments[0])},g,{get:function(){var t=this._currentEvent;return t?t.value:void 0},set:function(t){var e=this._currentEvent;o(this,e,e?e.value:void 0,t)},modify:function(t){var e=this._currentEvent,i=e?e.value:void 0;o(this,e,i,t(i))}}),$=f.inherit((0,f.id)(function(t){g.call(this),this._sources=t,this._source=this._$onSources=this._$onSource=void 0}),g,{get:(0,f.id)(function(){var t=this._source;return t&&t.get()}),modify:(0,f.id)(function(t){var e=this._source;e&&e.modify(t)}),_onActivation:function(){var i=this,t=this._sources;t&&t.onAny(this._$onSources=function(t){var e=t.type;e===l?(u(i),(i._source=t.value).onAny(i._$onSource=function(t){var e=t.type;e===l?r(i,i._source.get()):e===h?i._emitError(t.value):i._emitEnd()})):e===h?i._emitError(t.value):i._$onSources=void 0})},_onDeactivation:function(){u(this);var t=this._$onSources;t&&this._sources.offAny(t),this._$onSources=void 0}}),E=f.inherit(function(t){var e=[];!function t(e,i){if(_(e)&&i.indexOf(e)<0)i.push(e);else if(f.isArray(e))for(var n=0,r=e.length;n<r;++n)t(e[n],i);else if(f.isObject(e))for(var o in e)t(e[o],i)}(t,e),p.call(this,e.length?i.combine(e):a),this._template=t},p,{_getFromSource:function(){return function t(e){if(_(e))return e.get();if(f.isArray(e)){for(var i=e.length,n=e,r=0;r<i;++r){var o=t(e[r]);f.identicalU(n[r],o)||(n===e&&(n=e.slice(0)),n[r]=o)}return n}if(f.isObject(e)){var s=e;for(var u in e){var c=t(e[u]);f.identicalU(s[u],c)||(s===e&&(s=f.assocPartialU(void 0,void 0,e)),s[u]=c)}return s}return e}(this._template)},modify:function(t){var e=this,i=t(this.get());n(function(){return function t(e,i){if(_(e))e.set(i);else if(f.isArray(e)&&f.isArray(i))for(var n=0,r=e.length;n<r;++n)t(e[n],i[n]);else if(f.isObject(e)&&f.isObject(i))for(var o in e)t(e[o],i[o]);else f.identicalU(e,i)||s("Molecule cannot change the template.")}(e._template,i)})}});t.holding=n,t.AbstractMutable=g,t.MutableWithSource=p,t.LensedAtom=A,t.Atom=S,t.Join=$,t.Molecule=E,t.atom=c,t.default=c,Object.defineProperty(t,"__esModule",{value:!0})});
